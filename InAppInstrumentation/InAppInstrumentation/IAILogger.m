//
//  IAILogger.m
//  InAppInstrumentation
//
//  Created by Santthosh on 10/16/12.
//  Copyright (c) 2012 Santthosh. All rights reserved.
//

#import "IAILogger.h"

#if !defined(__has_feature) || !__has_feature(objc_arc)
#error "Nimbus requires ARC support."
#endif

NSString* const IAILoggerDidAddConsoleLog = @"IAIOverviewLoggerDidAddConsoleLog";

///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
@implementation IAILogger

@synthesize oldestLogAge = _oldestLogAge;
@synthesize deviceLogs = _deviceLogs;
@synthesize consoleLogs = _consoleLogs;
@synthesize eventLogs = _eventLogs;


///////////////////////////////////////////////////////////////////////////////////////////////////
- (id)init {
    if ((self = [super init])) {
        _deviceLogs = [[IAILinkedList alloc] init];
        _consoleLogs = [[IAILinkedList alloc] init];
        _eventLogs = [[IAILinkedList alloc] init];
        
        _oldestLogAge = 60;
    }
    return self;
}


///////////////////////////////////////////////////////////////////////////////////////////////////
- (void)pruneEntriesFromLinkedList:(IAILinkedList *)ll {
    NSDate* cutoffDate = [NSDate dateWithTimeIntervalSinceNow:-_oldestLogAge];
    while ([[((IAILogEntry *)[ll firstObject])
             timestamp] compare:cutoffDate] == NSOrderedAscending) {
        [ll removeFirstObject];
    }
}


///////////////////////////////////////////////////////////////////////////////////////////////////
- (void)addDeviceLog:(IAIDeviceLogEntry *)logEntry {
    [self pruneEntriesFromLinkedList:_deviceLogs];
    
    [_deviceLogs addObject:logEntry];
}


///////////////////////////////////////////////////////////////////////////////////////////////////
- (void)addConsoleLog:(IAIConsoleLogEntry *)logEntry {
    [_consoleLogs addObject:logEntry];
    
    [[NSNotificationCenter defaultCenter] postNotificationName: IAILoggerDidAddConsoleLog
                                                        object: nil
                                                      userInfo:
     [NSDictionary dictionaryWithObject:logEntry forKey:@"entry"]];
}


///////////////////////////////////////////////////////////////////////////////////////////////////
- (void)addEventLog:(IAIEventLogEntry *)logEntry {
    [self pruneEntriesFromLinkedList:_eventLogs];
    
    [_eventLogs addObject:logEntry];
}


@end


///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
@implementation IAILogEntry

@synthesize timestamp = _timestamp;


///////////////////////////////////////////////////////////////////////////////////////////////////
- (id)initWithTimestamp:(NSDate *)timestamp {
    if ((self = [super init])) {
        _timestamp = timestamp;
    }
    return self;
}


@end


///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
@implementation IAIDeviceLogEntry

@synthesize bytesOfFreeMemory = _bytesOfFreeMemory;
@synthesize bytesOfTotalMemory = _bytesOfTotalMemory;
@synthesize bytesOfTotalDiskSpace = _bytesOfTotalDiskSpace;
@synthesize bytesOfFreeDiskSpace = _bytesOfFreeDiskSpace;
@synthesize batteryLevel = _batteryLevel;
@synthesize batteryState = _batteryState;

@end


///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
@implementation IAIConsoleLogEntry

@synthesize log = _log;


///////////////////////////////////////////////////////////////////////////////////////////////////
- (id)initWithLog:(NSString *)logText {
    if ((self = [super initWithTimestamp:[NSDate date]])) {
        _log = [logText copy];
    }
    
    return self;
}


@end


///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////
@implementation IAIEventLogEntry

@synthesize type = _eventType;


///////////////////////////////////////////////////////////////////////////////////////////////////
- (id)initWithType:(NSInteger)type {
    if ((self = [super initWithTimestamp:[NSDate date]])) {
        _eventType = type;
    }
    
    return self;
}

@end
